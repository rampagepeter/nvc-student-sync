### **【开发需求文档】NVC中文网学员信息自动化同步工具**





#### **1. 项目概述**



**目标：** 开发一个内部Web应用，旨在自动化处理从小鹅通导出的学员报名数据（CSV格式），并将其智能同步至飞书多维表格。该工具需将学员的静态档案与动态学习行为分离，并建立两者之间的动态关联，将团队从重复的数据录入工作中解放出来，实现对学员学习旅程的自动化、结构化管理。

**核心价值：** 将手动的、易出错的数据整理工作，转变为一个高效、可靠、自动化的系统，为后续的数据分析、学员洞察和精细化运营提供高质量的数据基础。



#### **2. 核心业务流程**



用户与系统的交互流程如下：

1. **数据输入：** 用户访问Web界面，手动上传一份从小鹅通平台下载的最新课程学员名单（标准CSV文件格式）。
2. **数据处理：** 后端服务接收到CSV文件后，开始执行核心同步逻辑。
3. **数据输出：** 程序调用飞书多维表格API，完成对以下两个表的写入与关联操作。处理完成后，向前端返回清晰的处理结果报告（例如：新增X位学员，更新Y条学习记录）。



#### **3. 飞书多维表格数据结构定义**



本工具需要操作两个核心表格，它们的结构定义如下：

- **表一：`学员总表`**
  - **用途：** 存储学员的静态、核心档案信息。每个学员在此表中应只有一条唯一记录。
  - **关键字段：**
    - `用户ID` (文本类型, 主键): 学员在小鹅通的唯一标识，作为本系统进行匹配和识别的**唯一关键ID**。
    - `昵称` (文本类型)
    - `手机号` (文本类型)
    - *（其他可能的静态字段，如首次接触渠道、备注等）*
    - `学习记录` (关联记录类型): **此字段关联到`学习记录表`，并必须开启“允许链接多条记录”的开关。**
- **表二：`学习记录表`**
  - **用途：** 存储学员的动态学习行为。每次报名都生成一条新记录。
  - **关键字段：**
    - `用户ID` (文本类型): 用于与`学员总表`匹配的学员唯一标识。
    - `课程` (文本类型): 学员报名的课程名称。
    - `学习日期` (日期类型): 学员报名的日期。
    - `关联到学员总表` (关联记录类型): **此字段关联到`学员总表`。** 这是实现双向链接的核心。



#### **4. 关键实现逻辑（后端）**



这是本项目的核心，程序必须严格按照以下逻辑执行：

1. **接收并解析CSV：**
   - 后端接收前端上传的CSV文件。
   - 逐行读取CSV数据，将其转换为程序易于处理的数据结构（如对象列表），每行代表一个学员的一次报名行为。
2. **学员档案处理（更新/创建 `学员总表`）：**
   - 遍历解析后的CSV数据列表。
   - 对于列表中的 **每一个学员**，提取其 `用户ID`。
   - **调用飞书API:** 在 `学员总表` 中，使用 `用户ID` 作为查询条件进行 **记录查询**。
   - **逻辑判断：**
     - **如果查询到记录（老学员）：** 比较CSV中的 `昵称`、`手机号` 等静态信息与飞书中的信息。如果信息不一致，可选择性执行 **更新记录** 操作（更新策略可预设为“以新数据为准”）。**获取并暂存该学员在飞书中的`record_id`。**
     - **如果未查询到记录（新学员）：** 执行 **创建记录** 操作，将该学员的 `用户ID`、`昵称`、`手机号` 等静态信息写入 `学员总表` 的一个新行中。**获取新创建记录的`record_id`并暂存。**
   - *优化建议：为避免重复API请求，可先将CSV中所有不重复的`用户ID`进行一次批量查询，将结果缓存在内存中，构建一个 `用户ID -> record_id` 的映射表，以极大提升后续处理效率。*
3. **学习记录处理（创建记录并建立链接）：**
   - 再次遍历解析后的CSV数据列表。
   - 对于列表中的 **每一条报名记录**，执行 **创建记录** 操作，写入到 `学习记录表`。
   - 在创建这条学习记录的 **同一次API调用中**，必须包含以下数据：
     - `课程`: 从CSV中获取。
     - `学习日期`: 从CSV中获取。
     - `用户ID`: 从CSV中获取。
     - **`关联到学员总表`**: 字段的值，应设置为一个包含 **`record_id`** 的对象数组，格式为 `[{ "id": "刚刚在步骤2中获取到的对应学员的record_id" }]`。这是实现自动链接的**核心步骤**。



#### **5. Web界面（前端）要求**



- 界面需极度简洁，以功能为导向。
- 包含一个醒目的 **“上传CSV文件”** 按钮。
- 一个用于显示处理状态和结果的区域。例如，可以实时显示“正在处理第X条记录...”，处理完成后显示“处理完毕！成功创建X位新学员，新增Y条学习记录。失败Z条。”
- 提供清晰的错误提示。例如，当上传文件格式错误或飞书API密钥配置错误时，应给出明确指示。



#### **6. 技术栈与环境建议**



- **后端：** **Python** (使用 Flask 或 FastAPI 框架)。Python拥有强大的数据处理库（如 Pandas 读取CSV）和成熟的HTTP请求库（如 requests 调用API），非常适合此任务。
- **前端：** 简单的 HTML + CSS + 原生JavaScript即可满足需求。
- **API凭证管理：** 飞书应用的`App ID`和`App Secret`等敏感信息，**严禁硬编码在代码中**。应使用环境变量或安全的配置文件进行管理。