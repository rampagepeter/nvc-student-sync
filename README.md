# NVC学员信息自动化同步工具

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![FastAPI](https://img.shields.io/badge/FastAPI-0.104+-green.svg)](https://fastapi.tiangolo.com/)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

## 📋 项目概述

NVC学员信息自动化同步工具是一个专为NVC中文网设计的内部Web应用，旨在自动化处理从小鹅通平台导出的学员报名数据（CSV格式），并将其智能同步至飞书多维表格。

### 🎯 核心功能

- **自动化数据处理**: 解析小鹅通导出的CSV文件，支持多种编码格式
- **智能去重**: 基于用户ID自动识别新老学员
- **双表关联**: 学员档案与学习记录的动态关联
- **实时同步**: 调用飞书API自动创建和更新记录
- **高性能缓存**: 本地缓存学员数据，大幅提升查询速度（从3分钟优化到10秒以内）
- **字段冲突检测**: 智能检测并提示用户处理数据冲突
- **友好界面**: 简洁的Web界面，支持拖拽上传
- **详细日志**: 完整的处理过程记录和错误追踪
- **数据清理**: 自动清理特殊字符，解决字段类型不匹配问题

### 🏗️ 技术架构

- **后端**: Python + FastAPI + asyncio
- **前端**: HTML + CSS + JavaScript
- **数据处理**: pandas + aiohttp
- **API集成**: 飞书多维表格API
- **日志系统**: Python logging + 文件轮转

## 🚀 快速开始

### 环境要求

- Python 3.8+
- pip 包管理器
- 飞书应用凭证（App ID 和 App Secret）

### 安装步骤

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd student-sync-tool
   ```

2. **一键启动**
   ```bash
   python start.py
   ```
   
   启动脚本会自动：
   - 检查Python版本
   - 安装依赖包
   - 验证配置文件
   - 启动Web服务

3. **手动配置（可选）**
   
   如果需要手动配置，可以：
   
   a. **配置环境变量**
   ```bash
   # 创建 .env 文件，填入你的飞书应用凭证
   FEISHU_APP_ID=your_app_id_here
   FEISHU_APP_SECRET=your_app_secret_here
   ```
   
   b. **配置表格信息**
   
   编辑 `config/config.json` 文件，填入你的飞书多维表格信息：
   ```json
   {
     "student_table": {
       "app_token": "你的学员总表app_token",
       "table_id": "你的学员总表table_id"
     },
     "learning_record_table": {
       "app_token": "你的学习记录表app_token", 
       "table_id": "你的学习记录表table_id"
     }
   }
   ```

4. **访问应用**
   
   打开浏览器访问: http://localhost:8000

## 📊 飞书多维表格配置

### 学员总表结构

| 字段名 | 字段类型 | 说明 |
|--------|----------|------|
| 用户ID | 单行文本 | 小鹅通用户唯一标识（主键） |
| 昵称 | 单行文本 | 学员昵称 |
| 手机号 | 单行文本 | 学员手机号（推荐文本类型） |
| 录入时间 | 日期 | 记录创建时间 |
| 学习记录 | 关联记录 | 关联到学习记录表（开启多条记录） |

### 学习记录表结构

| 字段名 | 字段类型 | 说明 |
|--------|----------|------|
| 用户ID | 单行文本 | 学员用户ID |
| 课程 | 单行文本 | 报名课程名称 |
| 学习日期 | 日期 | 报名日期 |
| 录入时间 | 日期 | 记录创建时间 |
| 关联到学员总表 | 关联记录 | 关联到学员总表 |

### 飞书应用权限配置

确保你的飞书应用具有以下权限：
- `bitable:app` - 多维表格应用权限
- `bitable:record` - 记录读写权限

## 🔧 使用说明

### 1. 检查配置
- 启动应用后，首先检查配置状态
- 确保飞书应用凭证和表格配置正确
- 点击"测试飞书连接"验证API权限

### 2. 准备CSV文件
- 从小鹅通后台导出学员报名数据
- 确保包含必需字段：用户ID、昵称、课程、学习日期
- 可选字段：手机号
- 支持编码：UTF-8、GBK、GB2312

### 3. 上传并同步
- 支持点击上传或拖拽上传
- 文件格式：CSV，最大10MB
- 系统会自动验证文件格式和字段
- 点击"开始同步"执行数据同步

### 4. 查看结果
- 实时显示同步进度
- 完成后显示详细统计信息
- 包括新增学员数、新增记录数、错误统计等
- 详细的错误和警告信息

### 5. 处理字段冲突
- 系统自动检测字段冲突（如年龄、地址变更）
- 提供可视化界面选择处理方式
- 支持批量更新和单个处理
- 保留冲突记录供用户决策

### 6. 缓存管理
- 自动缓存飞书表格数据提升性能
- 手动刷新缓存功能
- 缓存状态实时显示
- 服务重启后自动恢复缓存

## 📁 项目结构

```
student-sync-tool/
├── backend/                # 后端代码
│   ├── app.py             # FastAPI应用入口 ✅
│   ├── config.py          # 配置管理 ✅
│   ├── feishu_client.py   # 飞书API客户端 ✅
│   ├── csv_processor.py   # CSV数据处理 ✅
│   ├── sync_service.py    # 同步业务逻辑 ✅
│   ├── cache_manager.py   # 缓存管理器 ✅
│   └── utils.py           # 工具函数 ✅
├── frontend/              # 前端代码
│   ├── index.html         # 主页面
│   ├── style.css          # 样式文件
│   └── script.js          # 前端逻辑
├── config/                # 配置文件
│   └── config.json        # 表格配置
├── logs/                  # 日志目录
├── requirements.txt       # Python依赖
├── start.py              # 一键启动脚本
└── README.md             # 项目说明
```

## 🛠️ 开发计划

### ✅ Phase 1: 基础架构（已完成）
- [x] 项目结构搭建
- [x] 配置管理系统
- [x] 日志系统
- [x] Web界面框架

### ✅ Phase 2: 飞书API集成（已完成）
- [x] 飞书API客户端
- [x] 认证和Token管理
- [x] 表格操作API
- [x] 记录查询和创建
- [x] CSV数据处理
- [x] 同步业务逻辑

### ✅ Phase 3: 性能与稳定性优化（已完成）
- [x] 高性能缓存系统（19K+记录，10秒内查询）
- [x] 字段冲突检测与处理
- [x] 数据清理与类型转换
- [x] NumberFieldConvFail错误修复
- [x] 缓存状态管理与持久化

### 📋 Phase 4: 高级功能（计划中）
- [ ] 数据回滚功能
- [ ] 同步历史记录
- [ ] 导入导出功能
- [ ] 数据统计分析

### 🎨 Phase 5: 界面完善（计划中）
- [ ] 数据预览功能
- [ ] 字段映射配置
- [ ] 主题切换
- [ ] 多语言支持

### 🧪 Phase 6: 测试和部署（计划中）
- [ ] 单元测试覆盖
- [ ] 性能测试
- [ ] Docker部署
- [ ] 生产环境配置

## ✨ 新功能亮点（V2.1.0）

### 🚀 V2.1.0 新增功能
- **高性能缓存系统**: 本地缓存19K+学员数据，查询速度从3分钟优化到10秒内
- **智能字段冲突处理**: 自动检测数据冲突，提供可视化处理界面
- **数据清理引擎**: 自动清理特殊字符（制表符、换行符等），解决数据格式问题
- **NumberFieldConvFail修复**: 彻底解决飞书API字段类型不匹配问题
- **缓存状态管理**: 实时显示缓存状态，支持手动刷新，服务重启自动恢复

### 📊 V2.0.0 核心功能
- **完整的飞书API集成**: 支持Token自动管理、表格操作、记录CRUD
- **智能CSV处理**: 自动检测编码、字段映射、数据验证
- **异步处理架构**: 基于asyncio的高性能数据处理
- **详细的进度反馈**: 实时同步状态、详细错误信息
- **连接测试功能**: 一键验证飞书API连接和表格配置
- **示例文件下载**: 提供标准CSV格式示例

## 🚨 注意事项

1. **敏感信息安全**: 飞书应用凭证不要提交到版本控制系统
2. **权限配置**: 确保飞书应用具有必要的API权限
3. **数据备份**: 同步前建议备份重要数据
4. **网络环境**: 确保服务器能够访问飞书API
5. **并发限制**: 单次处理建议不超过1000条记录

## 🐛 常见问题

### Q: 配置验证失败？
A: 检查环境变量和config.json文件是否正确配置，确保飞书凭证有效

### Q: 连接测试失败？
A: 检查网络连接、飞书应用权限、app_token和table_id是否正确

### Q: CSV文件上传失败？
A: 确保文件格式为CSV、编码为UTF-8/GBK、大小不超过10MB、包含必需字段

### Q: 同步过程中出现错误？
A: 查看详细错误信息，检查字段格式、数据完整性、飞书表格结构

### Q: 如何处理重复数据？
A: 系统基于用户ID自动去重，同一用户ID只会在学员总表中创建一条记录

### Q: 遇到NumberFieldConvFail错误怎么办？
A: 这通常是字段类型不匹配导致的。建议将飞书表格中的手机号字段设置为"文本"类型而非"数字"类型

### Q: 同步速度很慢怎么办？
A: 系统已集成高性能缓存，首次同步会稍慢（需要加载缓存），后续同步会显著提速

### Q: 字段冲突如何处理？
A: 系统会自动检测冲突并在界面中显示，用户可以选择保留原值或更新为新值

## 📝 更新日志

### v2.1.0 (2025-09-27)
- 🚀 **性能优化**: 高性能缓存系统，19K+记录查询从3分钟优化到10秒内
- 🔧 **字段冲突处理**: 智能检测并提供可视化界面处理数据冲突
- 🛠️ **数据清理引擎**: 自动清理制表符、换行符等特殊字符
- 🐛 **Bug修复**: 彻底解决NumberFieldConvFail错误
- 📊 **缓存管理**: 实时状态显示、手动刷新、自动持久化
- 🎨 **界面优化**: 改进冲突处理UI，增强用户体验

### v2.0.0 (2024-01-XX)
- 🎉 **重大更新**: 完整的飞书API集成
- ✅ CSV数据处理和验证
- 🔄 异步数据同步功能
- 🧪 连接测试和配置验证
- 📊 详细的同步结果展示
- 🎨 UI/UX优化和新功能

### v1.0.0 (2024-01-XX)
- 🎉 初始版本发布
- ✅ 基础架构搭建完成
- 🔧 配置管理系统
- 🎨 现代化Web界面
- 📊 日志系统

## 📄 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件

## 👥 贡献指南

欢迎提交Issue和Pull Request！

## 📞 联系我们

如有问题或建议，请联系NVC中文网技术团队。

---

**🚀 V2.1.0 现已发布**: 高性能缓存系统、字段冲突处理、数据清理引擎等重大功能优化，生产环境稳定运行！ 